function out = WMM(lat,long,alt) % [SI]

a = 6371200; % [m] - geomagnetic reference radius

R = LLA2ECEF(lat,long,alt);
r = norm(R);
latg = asin(R(3)/r);

Xp = 0;
Yp = 0;
Zp = 0;
for n=1:12
    
    P_norm = legendre(n,sin(latg),'sch');
    P_norm_ = legendre(n+1,sin(latg),'sch');
    
    Xp_nm = 0;
    Yp_nm = 0;
    Zp_nm = 0;
    for m=0:n
        
        DP_norm = (n+1)*tan(latg)*P_norm(m+1) - sqrt((n+1)^2-m^2)*sec(latg)*P_norm_(m+1);
        
        [g_nm,h_nm] = WMMCOF(n,m);
        
        Xp_nm = Xp_nm +   (g_nm*cos(m*long) + h_nm*sin(m*long))*DP_norm;
        Yp_nm = Yp_nm + m*(g_nm*sin(m*long) - h_nm*cos(m*long))*P_norm(m+1);
        Zp_nm = Zp_nm +   (g_nm*cos(m*long) + h_nm*sin(m*long))*P_norm(m+1);
        
    end
    
    Xp = Xp + Xp_nm*(a/r)^(n+2);
    Yp = Yp + Yp_nm*(a/r)^(n+2);
    Zp = Zp + Zp_nm*(n+1)*(a/r)^(n+2);
    
end
Xp = -Xp;
Yp = Yp/cos(latg);
Zp = -Zp;

X = Xp*cos(latg-lat) - Zp*sin(latg-lat);
Y = Yp;
Z = Xp*sin(latg-lat) + Zp*cos(latg-lat);

H = sqrt(X^2+Y^2);
F = sqrt(H^2+Z^2);
I = atan2(Z,H);
D = atan2(Y,X);

out = [X Y Z H F I D]';
% [X Y Z]'; % (nT) - World magnetic field in NED 
% [H F I D]; % (rad)

end

function [g_nm,h_nm] = WMMCOF(n,m)

COF = [
  1  0  -29404.5       0.0        6.7        0.0
  1  1   -1450.7    4652.9        7.7      -25.1
  2  0   -2500.0       0.0      -11.5        0.0
  2  1    2982.0   -2991.6       -7.1      -30.2
  2  2    1676.8    -734.8       -2.2      -23.9
  3  0    1363.9       0.0        2.8        0.0
  3  1   -2381.0     -82.2       -6.2        5.7
  3  2    1236.2     241.8        3.4       -1.0
  3  3     525.7    -542.9      -12.2        1.1
  4  0     903.1       0.0       -1.1        0.0
  4  1     809.4     282.0       -1.6        0.2
  4  2      86.2    -158.4       -6.0        6.9
  4  3    -309.4     199.8        5.4        3.7
  4  4      47.9    -350.1       -5.5       -5.6
  5  0    -234.4       0.0       -0.3        0.0
  5  1     363.1      47.7        0.6        0.1
  5  2     187.8     208.4       -0.7        2.5
  5  3    -140.7    -121.3        0.1       -0.9
  5  4    -151.2      32.2        1.2        3.0
  5  5      13.7      99.1        1.0        0.5
  6  0      65.9       0.0       -0.6        0.0
  6  1      65.6     -19.1       -0.4        0.1
  6  2      73.0      25.0        0.5       -1.8
  6  3    -121.5      52.7        1.4       -1.4
  6  4     -36.2     -64.4       -1.4        0.9
  6  5      13.5       9.0       -0.0        0.1
  6  6     -64.7      68.1        0.8        1.0
  7  0      80.6       0.0       -0.1        0.0
  7  1     -76.8     -51.4       -0.3        0.5
  7  2      -8.3     -16.8       -0.1        0.6
  7  3      56.5       2.3        0.7       -0.7
  7  4      15.8      23.5        0.2       -0.2
  7  5       6.4      -2.2       -0.5       -1.2
  7  6      -7.2     -27.2       -0.8        0.2
  7  7       9.8      -1.9        1.0        0.3
  8  0      23.6       0.0       -0.1        0.0
  8  1       9.8       8.4        0.1       -0.3
  8  2     -17.5     -15.3       -0.1        0.7
  8  3      -0.4      12.8        0.5       -0.2
  8  4     -21.1     -11.8       -0.1        0.5
  8  5      15.3      14.9        0.4       -0.3
  8  6      13.7       3.6        0.5       -0.5
  8  7     -16.5      -6.9        0.0        0.4
  8  8      -0.3       2.8        0.4        0.1
  9  0       5.0       0.0       -0.1        0.0
  9  1       8.2     -23.3       -0.2       -0.3
  9  2       2.9      11.1       -0.0        0.2
  9  3      -1.4       9.8        0.4       -0.4
  9  4      -1.1      -5.1       -0.3        0.4
  9  5     -13.3      -6.2       -0.0        0.1
  9  6       1.1       7.8        0.3       -0.0
  9  7       8.9       0.4       -0.0       -0.2
  9  8      -9.3      -1.5       -0.0        0.5
  9  9     -11.9       9.7       -0.4        0.2
 10  0      -1.9       0.0        0.0        0.0
 10  1      -6.2       3.4       -0.0       -0.0
 10  2      -0.1      -0.2       -0.0        0.1
 10  3       1.7       3.5        0.2       -0.3
 10  4      -0.9       4.8       -0.1        0.1
 10  5       0.6      -8.6       -0.2       -0.2
 10  6      -0.9      -0.1       -0.0        0.1
 10  7       1.9      -4.2       -0.1       -0.0
 10  8       1.4      -3.4       -0.2       -0.1
 10  9      -2.4      -0.1       -0.1        0.2
 10 10      -3.9      -8.8       -0.0       -0.0
 11  0       3.0       0.0       -0.0        0.0
 11  1      -1.4      -0.0       -0.1       -0.0
 11  2      -2.5       2.6       -0.0        0.1
 11  3       2.4      -0.5        0.0        0.0
 11  4      -0.9      -0.4       -0.0        0.2
 11  5       0.3       0.6       -0.1       -0.0
 11  6      -0.7      -0.2        0.0        0.0
 11  7      -0.1      -1.7       -0.0        0.1
 11  8       1.4      -1.6       -0.1       -0.0
 11  9      -0.6      -3.0       -0.1       -0.1
 11 10       0.2      -2.0       -0.1        0.0
 11 11       3.1      -2.6       -0.1       -0.0
 12  0      -2.0       0.0        0.0        0.0
 12  1      -0.1      -1.2       -0.0       -0.0
 12  2       0.5       0.5       -0.0        0.0
 12  3       1.3       1.3        0.0       -0.1
 12  4      -1.2      -1.8       -0.0        0.1
 12  5       0.7       0.1       -0.0       -0.0
 12  6       0.3       0.7        0.0        0.0
 12  7       0.5      -0.1       -0.0       -0.0
 12  8      -0.2       0.6        0.0        0.1
 12  9      -0.5       0.2       -0.0       -0.0
 12 10       0.1      -0.9       -0.0       -0.0
 12 11      -1.1      -0.0       -0.0        0.0
 12 12      -0.3       0.5       -0.1       -0.1
 ];

idx = fix(n*(n+1)/2+m); %fix(sum(2:1:n)+(m+1));
g_nm = COF(idx,3);
h_nm = COF(idx,4);

end
